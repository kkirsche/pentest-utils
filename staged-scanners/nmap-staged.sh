#!/bin/bash

if [ -z $1 ]; then
	echo '[!] Usage: ./nmap-staged.sh <target>'
	exit 1
fi

target=$1

tcp100='00-tcp-top100'
if ! [ -d $tcp100 ]; then
echo "[+] Beginning top 100 TCP port nmap scan against $target"
	mkdir $tcp100
	nmap -sS -T4 -sV -oA $tcp100/top-100 --stats-every 60s --max-retries 3 --defeat-rst-ratelimit --top-ports 100 --script banner --reason $target
else
	echo "[+] Top 1k TCP fast scan already exists. Skipping..."
fi

tcp1kdir='01-tcp-top1k'
if ! [ -d $tcp1kdir ]; then
echo "[+] Beginning top 1000 TCP port nmap scan against $target"
	mkdir $tcp1kdir
	nmap -sS -T4 -sV -oA $tcp1kdir/top-1k --stats-every 60s --max-retries 3 --defeat-rst-ratelimit --top-ports 1000 --script banner --reason $target
else
	echo "[+] Top 1k TCP fast scan already exists. Skipping..."
fi

tcpfulldir='02-tcp-full'
if ! [ -d $tcpfulldir ]; then 
	echo "[+] Running full TCP port scan against $target"
	mkdir $tcpfulldir
	nmap -sS -T4 -A -oA $tcpfulldir/full-tcp --stats-every 60s --max-retries 3 --defeat-rst-ratelimit -p- --reason $target
else
	echo "[+] Full TCP port scan directory already exists. Skipping..."
fi

udp50dir='03-udp-top50'
if ! [ -d $udp50dir ]; then
	echo "[+] Beginning top 50 UDP port nmap scan against $target"
	mkdir $udp50dir
	nmap -sU -T4 -sV -oA $udp50dir/top-50 --stats-every 60s --max-retries 3 --top-ports 50 --reason $target
else
	echo "[+] Top 1k UDP intensive nmap scan already exists. Skipping..."
fi

udp1kdir='04-udp-top1k'
if ! [ -d $udp1kdir ]; then
	echo "[+] Beginning top 1k UDP port nmap scan against $target"
	mkdir $udp1kdir
#	We'll be faster manually enumerating most times
	nmap -sU -T4 -A -oA $udp1kdir/top-1k --stats-every 60s --max-retries 3 --top-ports 1000 --reason $target
else
	echo "[+] Top 1k UDP intensive nmap scan already exists. Skipping..."
fi

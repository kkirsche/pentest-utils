#!/bin/bash

set -e
set -x

if [ -z "$1" ]; then
	echo '[!] Usage: ./smb-enumerator <target>'
	exit 1
fi

target="$1"

smbclientlist='01-smbclient-L.txt'
if ! [ -f "${smbclientlist}" ]; then
	echo "[+] Beginning smbclient -L //${target} against ${target}"
	smbclient -L "//${target}" |& tee "${smbclientlist}"
else
	echo "[+] smbclient -L seems to already exist. Skipping..."
fi

nbtscanreport='02-nbtscan.txt'
if ! [ -f "${nbtscanreport}" ]; then
	echo "[+] Beginning verbose nbtscan against ${target}"
	nbtscan -v "${target}" |& tee "${nbtscanreport}"
else
	echo "[+] nbtscan scan seems to already exist. Skipping..."
fi

enum4linuxreport='03-enum4linux.txt'
if ! [ -f "${enum4linuxreport}" ]; then
	echo "[+] Beginning full enum4linux scan against ${target}"
	enum4linux -a "${target}" |& tee "${enum4linuxreport}"
else
	echo "[+] enum4linux scan seems to already exist. Skipping..."
fi

smbsharelistreport='04-nmap-scripts'
if ! [ -f "${smbsharelistreport}.nmap" ]; then
	echo "[+] Beginning nmap SMB script enumeration against ${target}"
	nmap -T4 -oA "${smbsharelistreport}" --script smb-double-pulsar-backdoor,smb-server-stats,smb-system-info,smb-enum-*,smb-vuln-*,smb-os-discovery, --stats-every 60s -p139,445 "${target}"
else
	echo "[+] nmap share enumeration seems to already exist. Skipping..."
fi

#!/bin/bash

function usage()
{
	echo '[!] Usage: new-target <ip address> <name>'
	exit 1
}

function valid_ip()
{
    local  ip=$1
    local  stat=1

    if [[ $ip =~ ^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$ ]]; then
        OIFS=$IFS
        IFS='.'
        ip=($ip)
        IFS=$OIFS
        [[ ${ip[0]} -le 255 && ${ip[1]} -le 255 \
            && ${ip[2]} -le 255 && ${ip[3]} -le 255 ]]
        stat=$?
    fi
    return $stat
}

if [ -z $1 ]; then
	usage
fi

if [ -z $2 ]; then
	usage
fi

target="$1"
name="$2"

if valid_ip $target; then
	oct3="$(echo ${target} | cut -d '.' -f 3)"
	oct4="$(echo ${target} | cut -d '.' -f 4)"
	target_folder="${oct3}.${oct4}-${name}"

	recon_folder="01-recon"
	exploit_folder="02-exploitation"
	enumeration_folder="03-enumeration"
	proofs_folder="04-proofs"
	loot_folder="05-loot"
	

	echo "[+] Creating new target folder ${target_folder}"

	pushd . &>/dev/null
	mkdir ${target_folder}
	cd ${target_folder}
	echo "[+] Creating recon, exploit and post-exploitation folders"
	echo "[*] mkdir ${recon_folder} ${exploit_folder} ${enumeration_folder} ${proofs_folder} ${loot_folder}"
	mkdir ${recon_folder} ${exploit_folder} ${enumeration_folder} ${proofs_folder} ${loot_folder}
	
	pushd . &>/dev/null
	echo "[*] cd ${recon_folder}"
	cd ${recon_folder}
	echo "[+] Creating initial recon folders"
	for f in "00-unicorn" "01-nmap" "02-smb" "03-nikto" "04-dirb"; do
		echo "[*] mkdir ${f}"
		mkdir "$f"
	done
	popd &>/dev/null
	
	pushd . &>/dev/null
	echo "[*] cd ${exploit_folder}"
	cd ${exploit_folder}
	echo "[+] Creating initial exploit folders"
	for f in "00-potential" "01-attempts" "02-success" "03-success-privesc"; do
		echo "[*] mkdir ${f}"
		mkdir "$f"
	done
	pushd . &>/dev/null
	echo "[*] cd 02-success"
	cd "02-success"
	echo "[*] touch steps.txt"
	touch "steps.txt"
	popd &>/dev/null
	
	echo "[*] cd 03-success-privesc"
	cd "02-success-privesc"
	echo "[*] touch steps.txt"
	touch "steps.txt"
	popd &>/dev/null
	
	pushd . &>/dev/null
	echo "[*] cd ${enumeration_folder}"
	cd ${enumeration_folder}
	echo "[+] Creating enumeration folders"
	for f in "00-system" "01-network" "02-application"; do
		echo "[*] mkdir ${f}"
		mkdir "$f"
	done	
	popd &>/dev/null
	
	pushd . &>/dev/null
	echo "[*] cd ${proofs_folder}"
	cd ${proofs_folder}
	echo "[+] Creating proofs"
	for f in "proof.txt" "network-secret.txt" "local.txt"; do
		echo "[*] touch ${f}"
		touch "$f"
	done	
	popd &>/dev/null
	
	pushd . &>/dev/null
	echo "[*] cd ${loot_folder}"
	cd ${loot_folder}
	echo "[+] Creating loot folders"
	for f in "00-credentials" "01-files" "02-misc"; do
		echo "[*] mkdir ${f}"
		mkdir "$f"
	done	
	popd &>/dev/null
	
	pushd . &>/dev/null
	echo "[*] cd ${loot_folder}/00-credentials"
	cd ${loot_folder}/00-credentials
	echo "[+] Creating credentials info"
	for f in "hashes.txt" "plaintext-credentials.txt" "files.txt" "database.txt" "john_the_ripper.txt"; do
		echo "[*] touch ${f}"
		touch "$f"
	done	
	popd &>/dev/null

else

	echo '[!] Invalid IP address, exiting'
	exit 1
fi
